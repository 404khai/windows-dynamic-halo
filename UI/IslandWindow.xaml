<Window x:Class="WindowsDynamicHalo.UI.IslandWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:WindowsDynamicHalo.ViewModels"
        xmlns:uc="clr-namespace:WindowsDynamicHalo.UI.Controls"
        mc:Ignorable="d"
        Title="Dynamic Island"
        Height="35" 
        Width="80"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        SizeChanged="OnSizeChanged">
    
    <Window.DataContext>
        <vm:IslandViewModel />
    </Window.DataContext>

    <Window.Resources>
        <!-- Pink Slider Style -->
        <Style x:Key="PinkSliderStyle" TargetType="Slider">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="#FF2D55"/> <!-- iOS Pink/Red -->
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid VerticalAlignment="Center">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto" MinHeight="{TemplateBinding MinHeight}"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Track x:Name="PART_Track" Grid.Row="1">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="{x:Static Slider.DecreaseLarge}" Background="{TemplateBinding Foreground}" Height="4" BorderThickness="0" Template="{DynamicResource SliderRepeatButtonTemplate}"/>
                                </Track.DecreaseRepeatButton>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="{x:Static Slider.IncreaseLarge}" Background="{TemplateBinding Background}" Height="4" BorderThickness="0" Template="{DynamicResource SliderRepeatButtonTemplate}"/>
                                </Track.IncreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Width="12" Height="12" Background="{TemplateBinding Foreground}" Template="{DynamicResource SliderThumbTemplate}"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <ControlTemplate x:Key="SliderRepeatButtonTemplate" TargetType="RepeatButton">
            <Border Background="{TemplateBinding Background}" Height="4" CornerRadius="2"/>
        </ControlTemplate>
        <ControlTemplate x:Key="SliderThumbTemplate" TargetType="Thumb">
            <Grid>
                <Ellipse Fill="{TemplateBinding Background}" Width="12" Height="12"/>
            </Grid>
        </ControlTemplate>
    </Window.Resources>

    <Border x:Name="RootBorder" Background="Black" 
            CornerRadius="24"
            HorizontalAlignment="Stretch" 
            VerticalAlignment="Stretch"
            RenderTransformOrigin="0.5,0.5">
        <Border.RenderTransform>
            <ScaleTransform ScaleX="1" ScaleY="1"/>
        </Border.RenderTransform>

        <Grid>
            <!-- Background Click Target (Toggle Expand) -->
            <Button Command="{Binding ToggleExpandCommand}"
                    Background="Transparent" BorderThickness="0"
                    HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                    Opacity="0" Panel.ZIndex="0"/>

            <!-- Compact Media State -->
            <Grid x:Name="CompactState" VerticalAlignment="Center"
                  Opacity="0" Visibility="Collapsed">
                
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/> <!-- Art -->
                    <ColumnDefinition Width="*"/>    <!-- Text -->
                    <ColumnDefinition Width="Auto"/> <!-- Controls -->
                    <ColumnDefinition Width="Auto"/> <!-- Vis -->
                </Grid.ColumnDefinitions>

                <!-- Background Expand Button -->
                <Button Grid.ColumnSpan="4"
                        Command="{Binding ToggleExpandCommand}"
                        Background="Transparent"
                        BorderThickness="0"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        Panel.ZIndex="-1"/>
                
                <!-- Small Album Art -->
                <Border Margin="6,0,0,0" Width="36" Height="36" CornerRadius="18" Background="#222">
                     <Image Source="{Binding Media.AlbumArt}" Stretch="UniformToFill" ClipToBounds="True"/>
                </Border>

                <!-- Text -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10,0">
                    <TextBlock Text="{Binding Title}" Foreground="White" FontWeight="Bold" FontSize="12" TextTrimming="CharacterEllipsis"/>
                    <TextBlock Text="{Binding Artist}" Foreground="#AAAAAA" FontSize="11" TextTrimming="CharacterEllipsis"/>
                </StackPanel>

                <!-- Controls -->
                <uc:MediaControls Grid.Column="2" VerticalAlignment="Center" Margin="0,0,8,0"/>

                <!-- Visualizer -->
                <uc:Visualizer Grid.Column="3" IsActive="{Binding Media.IsPlaying}" Margin="0,0,15,0"/>
            </Grid>
            
            <!-- Expanded Media State -->
            <Grid x:Name="ExpandedState" Margin="15" Opacity="0" Visibility="Collapsed">
                 <Grid.ColumnDefinitions>
                     <ColumnDefinition Width="Auto"/> <!-- Large Art -->
                     <ColumnDefinition Width="*"/>    <!-- Content -->
                 </Grid.ColumnDefinitions>
                 
                 <!-- Large Album Art -->
                 <Border Grid.Column="0" Width="100" Height="100" CornerRadius="12" Background="#222" VerticalAlignment="Top" Margin="0,10,0,0">
                      <Border.Effect>
                          <DropShadowEffect ShadowDepth="4" BlurRadius="20" Opacity="0.4"/>
                      </Border.Effect>
                      <Image Source="{Binding Media.AlbumArt}" Stretch="UniformToFill" ClipToBounds="True"/>
                 </Border>

                 <!-- Content Right -->
                 <Grid Grid.Column="1" Margin="15,5,0,0">
                     <Grid.RowDefinitions>
                         <RowDefinition Height="Auto"/> <!-- Top: Info + Vis -->
                         <RowDefinition Height="*"/>    <!-- Middle: Slider -->
                         <RowDefinition Height="Auto"/> <!-- Bottom: Controls -->
                     </Grid.RowDefinitions>

                     <!-- Top Row -->
                     <Grid Grid.Row="0">
                         <Grid.ColumnDefinitions>
                             <ColumnDefinition Width="*"/>
                             <ColumnDefinition Width="Auto"/>
                         </Grid.ColumnDefinitions>
                         <StackPanel VerticalAlignment="Center">
                             <TextBlock Text="{Binding Title}" Foreground="White" FontWeight="Bold" FontSize="16" TextTrimming="CharacterEllipsis"/>
                             <TextBlock Text="{Binding Artist}" Foreground="#AAAAAA" FontSize="12" TextTrimming="CharacterEllipsis"/>
                         </StackPanel>
                         <uc:Visualizer Grid.Column="1" IsActive="{Binding Media.IsPlaying}" VerticalAlignment="Center"/>
                     </Grid>

                     <!-- Seek Slider -->
                     <Grid Grid.Row="1" VerticalAlignment="Center">
                         <Grid.ColumnDefinitions>
                             <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="*"/>
                             <ColumnDefinition Width="Auto"/>
                         </Grid.ColumnDefinitions>
                         
                         <TextBlock Text="{Binding Media.Position, StringFormat={}{0:mm\\:ss}}" Foreground="#888" FontSize="10" VerticalAlignment="Center" Margin="0,0,8,0"/>
                         
                         <Slider Grid.Column="1"
                                 Style="{StaticResource PinkSliderStyle}"
                                 Minimum="0" 
                                 Maximum="{Binding Media.TotalDurationSeconds, Mode=OneWay}" 
                                 Value="{Binding Media.CurrentPositionSeconds, Mode=TwoWay}"
                                 Thumb.DragStarted="OnSliderDragStarted"
                                 Thumb.DragCompleted="OnSliderDragCompleted"
                                 IsMoveToPointEnabled="True"/>

                         <TextBlock Grid.Column="2" Text="{Binding Media.Duration, StringFormat={}{0:mm\\:ss}}" Foreground="#888" FontSize="10" VerticalAlignment="Center" Margin="8,0,0,0"/>
                     </Grid>

                     <!-- Bottom Controls -->
                     <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,0,5">
                         <uc:MediaControls/>
                     </StackPanel>
                 </Grid>
            </Grid>
        </Grid>
    </Border>
</Window>
